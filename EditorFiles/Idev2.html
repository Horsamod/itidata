<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ace Mobile IDE Pro - Tabs</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-active: #1e1e1e; /* Tab active matches editor bg */
            --bg-tab-bar: #2d2d2d;
            --border: #333;
            --accent: #007acc;
            --danger: #ff6b6b;
            --text: #cccccc;
            --text-bright: #ffffff;
            --header-height: 50px;
            --tab-height: 35px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            height: 100vh;
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: var(--header-height);
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 30;
        }

        .brand { font-weight: 600; font-size: 1.1rem; color: var(--text-bright); display: flex; align-items: center; gap: 10px; }
        
        .actions { display: flex; gap: 8px; }
        .btn {
            background: #3c3c3c;
            border: 1px solid var(--border);
            color: var(--text-bright);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: var(--accent); border-color: var(--accent); }

        /* --- Layout --- */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 40;
            transition: transform 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* Sidebar Overlay (Mobile only) */
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 35;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s;
        }

        .explorer-header {
            padding: 10px 15px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            color: #888;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .explorer-actions i { margin-left: 10px; cursor: pointer; }
        .explorer-actions i:hover { color: var(--text-bright); }

        .file-tree { flex: 1; overflow-y: auto; padding: 5px 0; }
        
        /* Tree Nodes */
        .tree-node {
            padding: 6px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
            color: var(--text);
            border-left: 2px solid transparent;
        }
        .tree-node:hover { background: #2a2d2e; }
        .tree-node.active-file { background: #37373d; color: white; } /* Highlight in tree if open */

        .arrow { font-size: 0.7rem; color: #888; width: 14px; text-align: center; transition: transform 0.15s; }
        .arrow.expanded { transform: rotate(90deg); }
        .arrow.hidden { visibility: hidden; }
        
        .icon { width: 16px; text-align: center; }
        .icon.folder { color: #dcb67a; }
        .icon.file-html { color: #e34c26; }
        .icon.file-css { color: #563d7c; }
        .icon.file-js { color: #f1e05a; }
        .icon.file-default { color: #888; }

        /* --- Editor Area with Tabs --- */
        .editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            min-width: 0; /* Prevents flex overflow */
        }

        /* Tabs Bar */
        .tab-bar {
            height: var(--tab-height);
            background: var(--bg-tab-bar);
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        /* Hide scrollbar for tabs */
        .tab-bar::-webkit-scrollbar { height: 0px; background: transparent; }

        .tab {
            display: flex;
            align-items: center;
            padding: 0 10px;
            min-width: fit-content;
            max-width: 200px;
            background: var(--bg-tab-bar);
            color: #999;
            font-size: 0.85rem;
            cursor: pointer;
            border-right: 1px solid #1e1e1e;
            user-select: none;
        }
        .tab:hover { background: var(--bg-sidebar); }
        .tab.active {
            background: var(--bg-active);
            color: white;
            border-top: 2px solid var(--accent);
        }
        .tab-icon { margin-right: 6px; font-size: 0.8rem; }
        .tab-close {
            margin-left: 8px;
            padding: 2px;
            border-radius: 3px;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .tab-close:hover { background: #444; color: white; opacity: 1; }

        /* Actual Editor */
        #editor { flex: 1; }
        
        /* Empty State */
        #empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            background: var(--bg-dark);
        }
        #empty-state i { font-size: 3rem; margin-bottom: 10px; opacity: 0.3; }

        /* --- Context Menu --- */
        #context-menu {
            position: fixed;
            background: #252526;
            border: 1px solid #454545;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            padding: 4px 0;
            display: none;
            z-index: 9999;
            min-width: 160px;
        }
        .ctx-item { padding: 8px 15px; font-size: 0.85rem; cursor: pointer; color: #eee; display: flex; gap: 10px; }
        .ctx-item:hover { background: var(--accent); }
        .ctx-sep { height: 1px; background: #454545; margin: 4px 0; }

        /* --- Preview Overlay --- */
        #preview-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 50; display: none; flex-direction: column;
        }
        .preview-bar { background: #f0f0f0; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; color: #333; }
        #preview-frame { flex: 1; border: none; }

        /* --- Responsive --- */
        .toggle-btn { display: none; }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%); /* Hidden by default on mobile */
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); }
            
            .sidebar-overlay.active { display: block; opacity: 1; }
            
            .toggle-btn { display: block; }
            .brand span { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <button class="btn toggle-btn" onclick="toggleSidebar(true)"><i class="fas fa-bars"></i></button>
            <span><i class="fas fa-code" style="color:var(--accent)"></i> AceIDE</span>
        </div>
        <div class="actions">
            <button class="btn" onclick="saveProject()"><i class="fas fa-save"></i></button>
            <button class="btn btn-primary" onclick="runProject()"><i class="fas fa-play"></i> Run</button>
        </div>
    </header>

    <div class="workspace">
        
        <!-- Sidebar Overlay (Click outside to close) -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar(false)"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="explorer-header">
                <span>Explorer</span>
                <div class="explorer-actions">
                    <i class="fas fa-folder-plus" onclick="createNodeInRoot('folder')"></i>
                    <i class="fas fa-file-circle-plus" onclick="createNodeInRoot('file')"></i>
                </div>
            </div>
            <div id="tree-root" class="file-tree"></div>
        </div>

        <!-- Editor Wrapper -->
        <div class="editor-wrapper">
            <!-- Tab Bar -->
            <div class="tab-bar" id="tab-bar"></div>
            
            <!-- Editor Instance -->
            <div id="editor"></div>
            <!-- Empty State -->
            <div id="empty-state" style="display:none">
                <i class="fas fa-code"></i>
                <p>Select a file to edit</p>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu"></div>

    <!-- Preview -->
    <div id="preview-overlay">
        <div class="preview-bar">
            <strong>Preview</strong>
            <button class="btn" style="background:#e74c3c; border-color:#c0392b; padding:4px 10px;" onclick="closePreview()">Close</button>
        </div>
        <iframe id="preview-frame"></iframe>
    </div>

    <script>
        // --- 1. Setup Ace ---
        ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/');
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/tomorrow_night");
        editor.setFontSize(14);
        editor.setOptions({ enableBasicAutocompletion: true, enableLiveAutocompletion: true });

        // --- 2. State ---
        const DEFAULT_FS = {
            id: 'root', type: 'folder', name: 'root',
            children: [
                { id: 'f1', name: 'index.html', type: 'file', content: '<h1>Hello Tabs!</h1>' },
                { id: 'f2', name: 'style.css', type: 'file', content: 'h1 { color: cornflowerblue; }' },
                { id: 'f3', name: 'script.js', type: 'file', content: 'console.log("loaded");' }
            ]
        };
        
        let fsData = JSON.parse(localStorage.getItem('ace_fs_tabs')) || DEFAULT_FS;
        
        let sessions = {}; // ace Sessions
        let openTabs = []; // Array of file IDs currently open
        let currentFileId = null;
        let expandedFolders = new Set(['root']);
        
        // --- 3. Tree Rendering ---
        function renderTree() {
            const root = document.getElementById('tree-root');
            root.innerHTML = '';
            fsData.children.forEach(node => root.appendChild(createNodeEl(node, 0, 'root')));
        }

        function createNodeEl(node, depth, parentId) {
            const div = document.createElement('div');
            
            const row = document.createElement('div');
            row.className = `tree-node ${currentFileId === node.id ? 'active-file' : ''}`;
            row.style.paddingLeft = `${depth * 15 + 10}px`;
            
            row.onclick = (e) => {
                e.stopPropagation();
                if(node.type === 'folder') toggleFolder(node.id);
                else openFile(node.id);
            };
            
            row.oncontextmenu = (e) => {
                e.preventDefault(); e.stopPropagation();
                showContextMenu(e, node, parentId);
            };

            const arrow = node.type === 'folder' ? 
                `<i class="fas fa-chevron-right arrow ${expandedFolders.has(node.id) ? 'expanded' : ''}"></i>` : 
                `<i class="arrow"></i>`; // Spacer

            row.innerHTML = `${arrow} <i class="icon ${getIconClass(node)}"></i> <span>${node.name}</span>`;
            div.appendChild(row);

            if(node.type === 'folder' && expandedFolders.has(node.id)) {
                if(node.children && node.children.length) {
                    node.children.forEach(c => div.appendChild(createNodeEl(c, depth+1, node.id)));
                } else {
                    const empty = document.createElement('div');
                    empty.textContent = "Empty";
                    empty.style.paddingLeft = `${(depth+1)*15+10}px`;
                    empty.style.color = "#555";
                    empty.style.fontSize = "0.8em";
                    div.appendChild(empty);
                }
            }
            return div;
        }

        function getIconClass(node) {
            if (node.type === 'folder') return 'fas fa-folder folder';
            if (node.name.endsWith('.html')) return 'fab fa-html5 file-html';
            if (node.name.endsWith('.css')) return 'fab fa-css3-alt file-css';
            if (node.name.endsWith('.js')) return 'fab fa-js file-js';
            return 'fas fa-file';
        }

        function toggleFolder(id) {
            if(expandedFolders.has(id)) expandedFolders.delete(id);
            else expandedFolders.add(id);
            renderTree();
        }

        // --- 4. Tabs & Editor Logic ---
        
        function openFile(id) {
            const node = findNode(fsData.children, id);
            if(!node || node.type !== 'file') return;

            // 1. Add to open tabs if not present
            if(!openTabs.includes(id)) {
                openTabs.push(id);
            }

            // 2. Setup Session if needed
            if(!sessions[id]) {
                const mode = getMode(node.name);
                sessions[id] = ace.createEditSession(node.content || '', mode);
                sessions[id].on('change', () => { node.content = sessions[id].getValue(); });
            }

            // 3. Switch to it
            currentFileId = id;
            editor.setSession(sessions[id]);
            editor.focus();

            // 4. Update UI
            updateUI();
            
            // 5. Mobile: Close sidebar automatically
            if(window.innerWidth <= 768) {
                toggleSidebar(false);
            }
        }

        function closeTab(e, id) {
            e.stopPropagation(); // Prevent clicking the tab itself
            
            const idx = openTabs.indexOf(id);
            if(idx > -1) openTabs.splice(idx, 1);
            
            // Clean up session? (Optional, keeping for history usually better)
            
            // If we closed the current file
            if(currentFileId === id) {
                if(openTabs.length > 0) {
                    // Switch to the previous tab or first
                    const newId = openTabs[Math.max(0, idx - 1)];
                    openFile(newId);
                } else {
                    currentFileId = null;
                    updateUI(); // Shows empty state
                }
            } else {
                renderTabs(); // Just re-render tabs
            }
        }

        function updateUI() {
            renderTabs();
            renderTree(); // Update active highlight in tree
            
            const editorEl = document.getElementById('editor');
            const emptyEl = document.getElementById('empty-state');
            
            if(currentFileId) {
                editorEl.style.display = 'block';
                emptyEl.style.display = 'none';
            } else {
                editorEl.style.display = 'none';
                emptyEl.style.display = 'flex';
            }
        }

        function renderTabs() {
            const bar = document.getElementById('tab-bar');
            bar.innerHTML = '';
            
            openTabs.forEach(id => {
                const node = findNode(fsData.children, id);
                if(!node) return;
                
                const el = document.createElement('div');
                el.className = `tab ${currentFileId === id ? 'active' : ''}`;
                el.onclick = () => openFile(id);
                
                // Icon
                let iconClass = getIconClass(node).replace('file-', ''); // simplified
                el.innerHTML = `
                    <i class="tab-icon ${getIconClass(node)}"></i>
                    ${node.name}
                    <i class="fas fa-times tab-close" onclick="closeTab(event, '${id}')"></i>
                `;
                bar.appendChild(el);
            });
        }

        function getMode(name) {
            if(name.endsWith('.js')) return 'ace/mode/javascript';
            if(name.endsWith('.html')) return 'ace/mode/html';
            if(name.endsWith('.css')) return 'ace/mode/css';
            return 'ace/mode/text';
        }

        // --- 5. Sidebar Logic ---
        
        function toggleSidebar(forceState) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('open');
            const newState = typeof forceState === 'boolean' ? forceState : !isOpen;

            if (newState) {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            } else {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        }

        // --- 6. Helpers (Find, Save, Context Menu) ---
        function findNode(nodes, id) {
            for(let n of nodes) {
                if(n.id === id) return n;
                if(n.children) {
                    const found = findNode(n.children, id);
                    if(found) return found;
                }
            }
            return null;
        }

        function saveProject() {
            localStorage.setItem('ace_fs_tabs', JSON.stringify(fsData));
            const btn = document.querySelector('.fa-save').parentNode;
            btn.style.color = '#4cd137';
            setTimeout(() => btn.style.color = '', 1000);
        }

        // Context Menu & Actions (Same logic as previous, simplified for brevity)
        const ctxMenu = document.getElementById('context-menu');
        document.addEventListener('click', () => ctxMenu.style.display = 'none');
        
        let ctxTarget = null;
        function showContextMenu(e, node, parentId) {
            ctxTarget = { node, parentId };
            ctxMenu.innerHTML = '';
            
            if(node.type === 'folder') {
                addCtxItem('New File', 'fa-file-plus', () => createItem('file', node));
                addCtxItem('New Folder', 'fa-folder-plus', () => createItem('folder', node));
                addCtxDiv();
            }
            addCtxItem('Rename', 'fa-edit', () => renameItem(node));
            addCtxItem('Delete', 'fa-trash', () => deleteItem(node, parentId));
            
            ctxMenu.style.display = 'block';
            let x = e.clientX, y = e.clientY;
            if(x + 160 > window.innerWidth) x -= 160;
            ctxMenu.style.left = x + 'px';
            ctxMenu.style.top = y + 'px';
        }

        function addCtxItem(txt, icon, fn) {
            const div = document.createElement('div');
            div.className = 'ctx-item';
            div.innerHTML = `<i class="fas ${icon}"></i> ${txt}`;
            div.onclick = (e) => { e.stopPropagation(); ctxMenu.style.display='none'; fn(); };
            ctxMenu.appendChild(div);
        }
        function addCtxDiv() {
            const div = document.createElement('div');
            div.className = 'ctx-sep';
            ctxMenu.appendChild(div);
        }

        function createNodeInRoot(type) {
            createItem(type, { children: fsData.children }); // root mock
        }
        function createItem(type, parent) {
            const name = prompt("Name:");
            if(!name) return;
            const newNode = { id: Date.now().toString(), name, type, children: type==='folder'?[]:null, content: '' };
            parent.children.push(newNode);
            saveProject(); renderTree();
            if(type==='file') openFile(newNode.id);
        }
        function renameItem(node) {
            const n = prompt("New Name:", node.name);
            if(n) { node.name = n; saveProject(); renderTree(); updateUI(); }
        }
        function deleteItem(node, parentId) {
            if(!confirm("Delete?")) return;
            // Remove from parent
            let pChildren = parentId==='root' ? fsData.children : findNode(fsData.children, parentId).children;
            const idx = pChildren.findIndex(x => x.id === node.id);
            if(idx > -1) pChildren.splice(idx, 1);
            
            // Remove from tabs if open
            if(openTabs.includes(node.id)) {
                // If deleting current, close tab logic handles switch
                closeTab({stopPropagation:()=>{}}, node.id);
            }
            saveProject(); renderTree();
        }

        // --- 7. Run ---
        function runProject() {
            let files = {};
            function trav(list) { list.forEach(x => { if(x.type==='file') files[x.name]=x.content; if(x.children) trav(x.children); }); }
            trav(fsData.children);
            
            let html = files['index.html'] || 'No index.html';
            const css = files['style.css'];
            const js = files['script.js'];
            
            if(css) html = html.replace('</head>', `<style>${css}</style></head>`);
            if(js) html = html.replace('</body>', `<script>${js}<\/script></body>`);
            
            document.getElementById('preview-frame').srcdoc = html;
            document.getElementById('preview-overlay').style.display = 'flex';
        }
        function closePreview() { document.getElementById('preview-overlay').style.display='none'; }

        // Init
        renderTree();
        if(fsData.children[0] && fsData.children[0].type === 'file') openFile(fsData.children[0].id);

    </script>
</body>
</html>

